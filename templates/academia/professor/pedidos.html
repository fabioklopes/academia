{% extends 'academia/base.html' %}

{% block title %}Gerenciar Pedidos - Academia de Jiu-Jitsu{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h4>Controle de Pedidos</h4>
                {% if request.user.is_professor_or_admin %}
                    <a href="{% url 'professor_item_novo' %}" class="btn btn-outline-primary">Cadastrar Novo Produto</a>
                {% endif %}
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <form id="search-form" method="get" action="{% url 'professor_pedidos' %}">
                        <div class="input-group">
                            <input type="text" class="form-control" name="q" placeholder="Pesquisar por aluno ou item..." value="{{ query|default:'' }}">
                            <button class="btn btn-outline-secondary" type="submit">Pesquisar</button>
                        </div>
                    </form>
                </div>

                <div id="pedido-list">
                    {% include 'academia/professor/partials/pedidos_list.html' %}
                </div>
                
                <div class="mt-3">
                    <a href="{% url 'dashboard' %}" class="btn btn-outline-secondary">Voltar</a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modals -->
{% for pedido in pedidos %}
    <!-- Rejeitar Modal -->
    <div class="modal fade" id="rejectModal{{ pedido.id }}" tabindex="-1" aria-labelledby="rejectModalLabel{{ pedido.id }}" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="rejectModalLabel{{ pedido.id }}">Rejeitar Pedido</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form method="post" action="{% url 'professor_pedido_rejeitar' pedido.id %}">
                    {% csrf_token %}
                    <div class="modal-body">
                        <p>Tem certeza que deseja rejeitar o pedido de <strong>{{ pedido.aluno.get_full_name }}</strong> para <strong>{{ pedido.item.nome }}</strong>?</p>
                        <div class="mb-3">
                            <label for="rejection_reason{{ pedido.id }}" class="form-label">Motivo da Rejeição <span class="text-danger">*</span></label>
                            <textarea class="form-control" id="rejection_reason{{ pedido.id }}" name="rejection_reason" rows="3" required></textarea>
                            <small class="text-muted">Este motivo será exibido para o aluno.</small>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-outline-danger">Rejeitar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Cancelar Modal -->
    <div class="modal fade" id="cancelModal{{ pedido.id }}" tabindex="-1" aria-labelledby="cancelModalLabel{{ pedido.id }}" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-secondary text-white">
                    <h5 class="modal-title" id="cancelModalLabel{{ pedido.id }}">Cancelar Pedido</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form method="post" action="{% url 'professor_pedido_cancelar' pedido.id %}">
                    {% csrf_token %}
                    <div class="modal-body">
                        <p>Tem certeza que deseja cancelar o pedido de <strong>{{ pedido.aluno.get_full_name }}</strong> para <strong>{{ pedido.item.nome }}</strong>?</p>
                        <div class="mb-3">
                            <label for="cancellation_reason{{ pedido.id }}" class="form-label">Motivo do Cancelamento <span class="text-danger">*</span></label>
                            <textarea class="form-control" id="cancellation_reason{{ pedido.id }}" name="cancellation_reason" rows="3" required></textarea>
                            <small class="text-muted">Este motivo será informado ao aluno.</small>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Voltar</button>
                        <button type="submit" class="btn btn-outline-secondary">Confirmar Cancelamento</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Atender Modal (Aprovar) -->
    <div class="modal fade" id="approveModal{{ pedido.id }}" tabindex="-1" aria-labelledby="approveModalLabel{{ pedido.id }}" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="approveModalLabel{{ pedido.id }}">Atender Pedido</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form method="post" action="{% url 'professor_pedido_aprovar' pedido.id %}">
                    {% csrf_token %}
                    <div class="modal-body">
                        <p>Confirmar atendimento do pedido de <strong>{{ pedido.aluno.get_full_name }}</strong> para <strong>{{ pedido.item.nome }}</strong>?</p>
                        <p class="text-muted">Após atender, o pedido ficará aguardando para ser entregue.</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-outline-primary">Atender</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Entregar Modal -->
    <div class="modal fade" id="deliverModal{{ pedido.id }}" tabindex="-1" aria-labelledby="deliverModalLabel{{ pedido.id }}" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-info text-dark">
                    <h5 class="modal-title" id="deliverModalLabel{{ pedido.id }}">Entregar Pedido</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form method="post" action="{% url 'professor_pedido_entregar' pedido.id %}">
                    {% csrf_token %}
                    <div class="modal-body">
                        <p>Confirmar entrega do pedido de <strong>{{ pedido.aluno.get_full_name }}</strong> para <strong>{{ pedido.item.nome }}</strong>?</p>
                        <div class="mb-3">
                            <label for="final_value{{ pedido.id }}" class="form-label">Valor Final (opcional)</label>
                            <input type="number" step="0.01" class="form-control" id="final_value{{ pedido.id }}" name="final_value" value="{{ pedido.item.valor|default:'' }}">
                        </div>
                        <p class="text-muted small">O estoque será descontado após a entrega.</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-outline-info">Confirmar Entrega</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Finalizar Modal -->
    <div class="modal fade" id="finalizeModal{{ pedido.id }}" tabindex="-1" aria-labelledby="finalizeModalLabel{{ pedido.id }}" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title" id="finalizeModalLabel{{ pedido.id }}">Finalizar Pedido</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form method="post" action="{% url 'professor_pedido_finalizar' pedido.id %}">
                    {% csrf_token %}
                    <div class="modal-body">
                        <p>Confirmar finalização do pedido de <strong>{{ pedido.aluno.get_full_name }}</strong> para <strong>{{ pedido.item.nome }}</strong>?</p>
                        <p class="text-muted">O pedido será marcado como finalizado.</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-outline-success">Finalizar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
{% endfor %}
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchForm = document.getElementById('search-form');
    const pedidoListContainer = document.getElementById('pedido-list');
    const queryInput = searchForm.querySelector('input[name="q"]');

    function fetchPedidos(url) {
        fetch(url, {
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.text())
        .then(html => {
            pedidoListContainer.innerHTML = html;
            window.history.pushState({path: url}, '', url);
        })
        .catch(error => console.error('Erro ao carregar os pedidos:', error));
    }

    searchForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const query = queryInput.value;
        const url = `{% url 'professor_pedidos' %}?q=${encodeURIComponent(query)}`;
        fetchPedidos(url);
    });

    pedidoListContainer.addEventListener('click', function(e) {
        if (e.target.matches('.pagination a')) {
            e.preventDefault();
            const url = e.target.href;
            fetchPedidos(url);
        }
    });

    window.addEventListener('popstate', function(e) {
        if (e.state && e.state.path) {
            fetchPedidos(e.state.path);
        }
    });
});
</script>
{% endblock %}
