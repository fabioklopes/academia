{% extends 'academia/base.html' %}
{% block title %}Meu Perfil - Academia de Jiu-Jitsu{% endblock %}

{% block content %}
    <div class="container-fluid">
        <h4 class="mb-4">Meu Perfil</h4>

        <div class="row g-4">
            <!-- Coluna Esquerda: Perfil e Senha -->
            <div class="col-12 col-lg-4">
                <!-- Bloco: Dados do Perfil -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">Dados Pessoais</h5>
                    </div>
                    <div class="card-body">
                        <div class="text-center mb-4">
                            {% if user.photo %}
                                <img src="{{ user.photo.url }}" alt="Foto" class="rounded-circle mb-3" width="150"
                                     height="150">
                            {% else %}
                                <div class="bg-secondary rounded-circle mx-auto mb-3 d-flex align-items-center justify-content-center"
                                     style="width: 150px; height: 150px;">
                                    <i class="bi bi-person text-white" style="font-size: 4rem;"></i>
                                </div>
                            {% endif %}
                            <h5>{{ user.first_name }} {{ user.last_name }}</h5>
                            <p class="text-muted mb-1">{{ user.email }}</p>
                            {% if graduacao %}
                                {% if graduacao.grau > 0 %}
                                    <img src="/media/faixas/{{ graduacao.faixa }}_{{ graduacao.grau }}_DEGREES.png" alt="{{ graduacao.get_faixa_display }} {{ graduacao.grau }}º grau" class="img-fluid mt-2" style="max-height: 40px;">
                                {% else %}
                                    <img src="/media/faixas/{{ graduacao.faixa }}.png" alt="{{ graduacao.get_faixa_display }}" class="img-fluid mt-2" style="max-height: 40px;">
                                {% endif %}
                            {% else %}
                                <span class="badge bg-secondary">Sem graduação</span>
                            {% endif %}
                        </div>

                        <div class="mb-2"><strong>Nome:</strong> {{ user.first_name }}</div>
                        <div class="mb-2"><strong>Sobrenome:</strong> {{ user.last_name }}</div>
                        <div class="mb-2"><strong>Email:</strong> {{ user.email }}</div>
                        {% if user.id != 1 and user.id != 2 and user.id != 7 and user.id != 39 and user.id != 110 %}
                        <div class="mb-2"><strong>Data de Nascimento:</strong> {{ user.birthday|date:"d/m/Y"|default:"Não informado" }}</div>
                        {% endif %}
                        <div class="mb-2"><strong>Perfil:</strong> {{ user.get_group_role_display }}</div>
                        <div class="mb-2"><strong>Status:</strong> {{ user.get_status_display }} </div>
                        <div class="mb-2"><strong>UUID:</strong> {{ user.id }} </div>

                        <hr>
                        <div class="d-grid gap-2">
                            <a href="{% url 'perfil_editar' %}" class="btn btn-outline-primary">Editar Perfil</a>
                            <a href="{% url 'dashboard' %}" class="btn btn-outline-secondary">Voltar</a>
                        </div>
                    </div>
                </div>

                <!-- Bloco: Alterar Senha -->
                <div class="card shadow-sm">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">Alterar Senha</h5>
                    </div>
                    <div class="card-body">
                        <form method="post" action="{% url 'perfil' %}">
                            {% csrf_token %}
                            <input type="hidden" name="action" value="change_password">
                            <div class="mb-3"><label for="current_password" class="form-label">Senha Atual</label><input type="password" class="form-control" id="current_password" name="current_password" required></div>
                            <div class="mb-3"><label for="new_password" class="form-label">Nova Senha</label><input type="password" class="form-control" id="new_password" name="new_password" required></div>
                            <div class="mb-3"><label for="confirm_new_password" class="form-label">Confirmar Nova Senha</label><input type="password" class="form-control" id="confirm_new_password" name="confirm_new_password" required></div>
                            <hr>
                            <div class="d-grid">
                                <button type="submit" class="btn btn-outline-primary">Alterar Senha</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Coluna Direita: Meu Kimono -->
            <div class="col-12 col-lg-8 mb-4">
                <div class="card shadow-sm h-100">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">Meu Kimono</h5>
                    </div>
                    <div class="card-body">
                        <form method="post" action="{% url 'perfil' %}">
                            {% csrf_token %}
                            <input type="hidden" name="action" value="update_kimono">
                            <div class="row">
                                <!-- Coluna de Inserção de Dados -->
                                <div class="col-md-4 mb-4 mb-md-0">
                                    <h6 class="mb-3">Seus Dados</h6>
                                    <div class="row">
                                        <div class="col-6 mb-3">
                                            <label for="height" class="form-label">Altura (cm)</label>
                                            <input type="number" class="form-control" id="height" name="height" value="{{ user.height|default_if_none:'' }}">
                                        </div>
                                        <div class="col-6 mb-3">
                                            <label for="weight" class="form-label">Peso (kg)</label>
                                            <input type="number" class="form-control" id="weight" name="weight" value="{{ user.weight|default_if_none:'' }}">
                                        </div>
                                    </div>
                                </div>

                                <!-- Coluna das Tabelas -->
                                <div class="col-md-8">
                                    <!-- Tabela de Kimonos -->
                                    <div class="mb-4">
                                        <h6 class="mb-2">Tamanho do Kimono</h6>
                                        <p class="mb-2 small text-muted">Tamanho selecionado: <span id="selectedKimonoSize" class="fw-bold text-dark">{{ user.kimono_size|default:"Nenhum" }}</span></p>
                                        <input type="hidden" id="kimono_size" name="kimono_size" value="{{ user.kimono_size|default_if_none:'' }}">
                                        <div class="table-responsive">
                                            <table class="table table-bordered table-hover text-center table-sm" id="kimonoTable">
                                                <thead class="table-light">
                                                    <tr>
                                                        <th>Tam</th>
                                                        <th>Altura</th>
                                                        <th>Peso</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <tr data-size="A0" data-min-height="155" data-max-height="160" data-max-weight="60"><td>A0</td><td>1,55-1,60m</td><td>até 60kg</td></tr>
                                                    <tr data-size="A1" data-min-height="160" data-max-height="170" data-max-weight="75"><td>A1</td><td>1,60-1,70m</td><td>até 75kg</td></tr>
                                                    <tr data-size="A2" data-min-height="170" data-max-height="180" data-max-weight="85"><td>A2</td><td>1,70-1,80m</td><td>até 85kg</td></tr>
                                                    <tr data-size="A3" data-min-height="180" data-max-height="190" data-max-weight="95"><td>A3</td><td>1,80-1,90m</td><td>até 95kg</td></tr>
                                                    <tr data-size="A4" data-min-height="190" data-max-height="200" data-max-weight="110"><td>A4</td><td>1,90-2,00m</td><td>até 110kg</td></tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>

                                    <!-- Tabela de Faixas -->
                                    <div>
                                        <h6 class="mb-2">Tamanho da Faixa</h6>
                                        <p class="mb-2 small text-muted">Tamanho selecionado: <span id="selectedBeltSize" class="fw-bold text-dark">{{ user.belt_size|default:"Nenhum" }}</span></p>
                                        <input type="hidden" id="belt_size" name="belt_size" value="{{ user.belt_size|default_if_none:'' }}">
                                        <div class="table-responsive">
                                            <table class="table table-bordered table-hover text-center table-sm" id="beltTable">
                                                <thead class="table-light">
                                                    <tr>
                                                        <th>Tam</th>
                                                        <th>Medida</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <tr data-size="A0"><td>A0</td><td>2,40m</td></tr>
                                                    <tr data-size="A1"><td>A1</td><td>2,60m</td></tr>
                                                    <tr data-size="A2"><td>A2</td><td>2,80m</td></tr>
                                                    <tr data-size="A3"><td>A3</td><td>3,00m</td></tr>
                                                    <tr data-size="A4"><td>A4</td><td>3,20m</td></tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                    <hr>
                                    <div class="d-grid bm-5">
                                        <button type="submit" class="btn btn-outline-primary">Salvar Informações</button>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
    {{ block.super }}
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // --- Lógica para o Kimono ---
            const heightInput = document.getElementById('height');
            const weightInput = document.getElementById('weight');
            const kimonoTable = document.getElementById('kimonoTable');
            const kimonoSizeInput = document.getElementById('kimono_size');
            const selectedKimonoSize = document.getElementById('selectedKimonoSize');
            const kimonoRows = kimonoTable.querySelectorAll('tbody tr');

            function getRecommendedSize(height, weight) {
                for (const row of kimonoRows) {
                    const minHeight = parseInt(row.dataset.minHeight);
                    const maxHeight = parseInt(row.dataset.maxHeight);
                    const maxWeight = parseInt(row.dataset.maxWeight);
                    if (height >= minHeight && height <= maxHeight && weight <= maxWeight) {
                        return row.dataset.size;
                    }
                }
                // Lógica de fallback se o peso for o fator decisivo
                for (const row of kimonoRows) {
                    if (weight <= parseInt(row.dataset.maxWeight)) return row.dataset.size;
                }
                return null;
            }

            function updateKimonoSelection(isManualClick = false) {
                const height = parseInt(heightInput.value);
                const weight = parseInt(weightInput.value);
                const currentManualSize = kimonoSizeInput.value;

                kimonoRows.forEach(r => r.classList.remove('table-primary', 'table-active'));

                // Só faz a recomendação se não for um clique manual
                if (!isManualClick && height && weight) {
                    const recommendedSize = getRecommendedSize(height, weight);
                    if (recommendedSize) {
                        const recommendedRow = kimonoTable.querySelector(`tr[data-size="${recommendedSize}"]`);
                        if (recommendedRow) {
                            recommendedRow.classList.add('table-primary');
                            // Se não houver seleção manual, a recomendação vira a seleção
                            if (!currentManualSize) {
                                kimonoSizeInput.value = recommendedSize;
                                selectedKimonoSize.textContent = recommendedSize;
                            }
                        }
                    }
                }
                
                // Restaura a seleção manual do usuário se houver
                if (currentManualSize) {
                    const selectedRow = kimonoTable.querySelector(`tr[data-size="${currentManualSize}"]`);
                    if (selectedRow) {
                        selectedRow.classList.add('table-active');
                        selectedKimonoSize.textContent = currentManualSize;
                    }
                }

                if (!kimonoSizeInput.value) {
                    selectedKimonoSize.textContent = "Nenhum";
                }
            }

            heightInput.addEventListener('input', () => updateKimonoSelection(false));
            weightInput.addEventListener('input', () => updateKimonoSelection(false));

            kimonoRows.forEach(row => {
                row.addEventListener('click', () => {
                    const size = row.dataset.size;
                    kimonoSizeInput.value = size;
                    updateKimonoSelection(true); // Indica que é um clique manual
                });
            });

            // --- Lógica para a Faixa ---
            const beltTable = document.getElementById('beltTable');
            const beltSizeInput = document.getElementById('belt_size');
            const selectedBeltSize = document.getElementById('selectedBeltSize');
            const beltRows = beltTable.querySelectorAll('tbody tr');

            function updateBeltSelection() {
                const currentBeltSize = beltSizeInput.value;
                beltRows.forEach(r => r.classList.remove('table-active'));
                if (currentBeltSize) {
                    const selectedRow = beltTable.querySelector(`tr[data-size="${currentBeltSize}"]`);
                    if (selectedRow) {
                        selectedRow.classList.add('table-active');
                    }
                    selectedBeltSize.textContent = currentBeltSize;
                } else {
                    selectedBeltSize.textContent = "Nenhum";
                }
            }

            beltRows.forEach(row => {
                row.addEventListener('click', () => {
                    const size = row.dataset.size;
                    beltSizeInput.value = size;
                    updateBeltSelection();
                });
            });

            // --- Inicialização ---
            updateKimonoSelection();
            updateBeltSelection();
        });
    </script>
{% endblock %}